# compare_procedures.ps1
# PowerShell script ile daha güzel ilerleme göstergesi

Clear-Host
Write-Host "====================================" -ForegroundColor Cyan
Write-Host "   Hizli Prosedur Karsilastirma" -ForegroundColor Cyan
Write-Host "====================================" -ForegroundColor Cyan
Write-Host ""

# Kullanıcı bilgilerini al
$username = Read-Host "Oracle kullanici"
$password = Read-Host "Oracle sifre" -AsSecureString
$password = [Runtime.InteropServices.Marshal]::PtrToStringAuto([Runtime.InteropServices.Marshal]::SecureStringToBSTR($password))
$database = Read-Host "Database"
$procdir = Read-Host "Prosedur dizini"

# Liste.txt'yi oku
$procedures = Get-Content "liste.txt"
$total = $procedures.Count

Write-Host ""
Write-Host "Toplam $total prosedur kontrol edilecek." -ForegroundColor Yellow
Write-Host ""

# Export SQL oluştur
@"
SET HEADING OFF
SET FEEDBACK OFF
SET PAGESIZE 0
SET LINESIZE 32767
SET TRIMSPOOL ON
SET TERMOUT OFF
SET LONG 1000000
SELECT text FROM all_source WHERE owner = UPPER('&1') AND name = UPPER('&2') AND type = 'PROCEDURE' ORDER BY line;
EXIT;
"@ | Out-File -FilePath "exp.sql" -Encoding ASCII

# Sonuç değişkenleri
$count = 0
$same = 0
$different = 0
$notfound = 0
$farkList = @()

# İlerleme göster
foreach ($line in $procedures) {
    $count++
    $parts = $line.Split('.')
    $schema = $parts[0]
    $procname = $parts[1]
    
    # İlerleme çubuğu
    $percent = [math]::Round(($count / $total) * 100)
    Write-Progress -Activity "Prosedurler kontrol ediliyor..." `
                   -Status "[${count}/${total}] $schema.$procname | Ayni: $same - Farkli: $different - Dosya Yok: $notfound" `
                   -PercentComplete $percent
    
    # Dosya kontrolü
    if (Test-Path "$procdir\$procname.prc") {
        # DB'den export et
        & sqlplus -s "$username/$password@$database" @exp.sql $schema $procname > temp.prc 2>$null
        
        # Karşılaştır
        $dbContent = Get-Content "temp.prc" -Raw
        $fileContent = Get-Content "$procdir\$procname.prc" -Raw
        
        if ($dbContent -eq $fileContent) {
            $same++
        } else {
            $different++
            $farkList += "$schema.$procname"
        }
        
        Remove-Item "temp.prc" -Force -ErrorAction SilentlyContinue
    } else {
        $notfound++
        $farkList += "$schema.$procname - DOSYA YOK"
    }
}

# İlerleme çubuğunu kaldır
Write-Progress -Activity "Prosedurler kontrol ediliyor..." -Completed

# Fark.txt oluştur
$farkContent = @"
Farkli Prosedurler Listesi
Tarih: $(Get-Date -Format "dd.MM.yyyy HH:mm:ss")
================================

$($farkList -join "`n")

===== OZET =====
Toplam: $count
Ayni: $same
Farkli: $different
Dosya yok: $notfound
"@

$farkContent | Out-File -FilePath "fark.txt" -Encoding UTF8

# Temizlik
Remove-Item "exp.sql" -Force -ErrorAction SilentlyContinue

# Özet rapor
Write-Host ""
Write-Host "====================================" -ForegroundColor Green
Write-Host "          OZET RAPOR" -ForegroundColor Green
Write-Host "====================================" -ForegroundColor Green
Write-Host "Toplam kontrol edilen: $count"
Write-Host "Ayni olan: $same" -ForegroundColor Green
Write-Host "Farkli olan: $different" -ForegroundColor Red
Write-Host "Dosya bulunamayan: $notfound" -ForegroundColor Yellow
Write-Host "====================================" -ForegroundColor Green

if ($different -gt 0 -or $notfound -gt 0) {
    Write-Host ""
    Write-Host "Farkli ve bulunamayan prosedurler 'fark.txt' dosyasina kaydedildi." -ForegroundColor Yellow
    
    if ($different -gt 0) {
        Write-Host ""
        Write-Host "FARKLI PROSEDURLER:" -ForegroundColor Red
        Write-Host "-------------------"
        $farkList | Where-Object { $_ -notlike "*DOSYA YOK*" } | ForEach-Object { Write-Host $_ }
    }
}

Write-Host ""
Read-Host "Devam etmek icin Enter'a basin"

# Fark.txt'yi aç
if ($different -gt 0 -or $notfound -gt 0) {
    $openFile = Read-Host "Fark.txt dosyasini acmak ister misiniz? (E/H)"
    if ($openFile -eq 'E' -or $openFile -eq 'e') {
        Start-Process notepad.exe fark.txt
    }
}
