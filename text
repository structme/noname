# simple_compare.ps1 - Basit ama hızlı karşılaştırma

Clear-Host
Write-Host "====================================" -ForegroundColor Cyan
Write-Host "   Prosedur Karsilastirma (Basit)" -ForegroundColor Cyan
Write-Host "====================================" -ForegroundColor Cyan
Write-Host ""

# Kullanıcı bilgileri
$username = Read-Host "Oracle kullanici"
$password = Read-Host "Oracle sifre"
$database = Read-Host "Database"
$procdir = Read-Host "Prosedur dizini"

# Export SQL
@"
SET HEADING OFF
SET FEEDBACK OFF
SET PAGESIZE 0
SET LINESIZE 32767
SET TRIMSPOOL ON
SET TERMOUT OFF
SET LONG 1000000
SELECT text FROM all_source WHERE owner = UPPER('&1') AND name = UPPER('&2') AND type = 'PROCEDURE' ORDER BY line;
EXIT;
"@ | Out-File -FilePath "exp.sql" -Encoding ASCII

# Liste oku
$procedures = Get-Content "liste.txt"
$total = $procedures.Count

Write-Host "`nToplam $total prosedur kontrol edilecek." -ForegroundColor Yellow
Write-Host ""

# Sonuç listeleri
$farkList = @()
$same = 0
$different = 0
$notfound_db = 0
$notfound_file = 0

# Ana döngü
$count = 0
foreach ($line in $procedures) {
    $count++
    $parts = $line.Split('.')
    
    if ($parts.Count -ne 2) { continue }
    
    $schema = $parts[0]
    $procname = $parts[1]
    
    # İlerleme
    Write-Host "`r[$count/$total] $schema.$procname kontrol ediliyor...                    " -NoNewline
    
    $localFile = "$procdir\$procname.prc"
    
    # Lokal dosya var mı?
    if (-not (Test-Path $localFile)) {
        $farkList += "$schema.$procname - LOKAL DOSYA YOK"
        $notfound_file++
        continue
    }
    
    # DB'den export
    & sqlplus -s "$username/$password@$database" @exp.sql $schema $procname > temp.prc 2>$null
    
    # DB'de var mı?
    if ((Get-Item temp.prc).Length -eq 0) {
        $farkList += "$schema.$procname - DB'DE YOK"
        $notfound_db++
        Remove-Item temp.prc
        continue
    }
    
    # İçerik karşılaştır
    $dbContent = Get-Content temp.prc -Raw
    $fileContent = Get-Content $localFile -Raw
    
    if ($dbContent.Trim() -ne $fileContent.Trim()) {
        $farkList += "$schema.$procname - FARKLI"
        $different++
    } else {
        $same++
    }
    
    Remove-Item temp.prc
}

Write-Host "`r                                                                           "

# Rapor oluştur
@"
Prosedur Karsilastirma Raporu
Tarih: $(Get-Date -Format "dd.MM.yyyy HH:mm:ss")
=============================

$($farkList -join "`n")

===== OZET =====
Toplam: $total
Ayni: $same
Farkli: $different
DB'de Yok: $notfound_db
Dosya Yok: $notfound_file
"@ | Out-File -FilePath "fark.txt" -Encoding UTF8

# Temizlik
Remove-Item "exp.sql" -Force

# Özet
Write-Host ""
Write-Host "====================================" -ForegroundColor Green
Write-Host "          OZET RAPOR" -ForegroundColor Green
Write-Host "====================================" -ForegroundColor Green
Write-Host "Toplam: $total"
Write-Host "Ayni: $same" -ForegroundColor Green
Write-Host "Farkli: $different" -ForegroundColor Red
Write-Host "DB'de Yok: $notfound_db" -ForegroundColor Yellow
Write-Host "Dosya Yok: $notfound_file" -ForegroundColor Yellow
Write-Host "====================================" -ForegroundColor Green

if ($farkList.Count -gt 0) {
    Write-Host "`nFarkli/eksik prosedurler 'fark.txt' dosyasina kaydedildi." -ForegroundColor Yellow
    
    $open = Read-Host "`nFark.txt'yi acmak ister misiniz? (E/H)"
    if ($open -eq 'E') {
        Start-Process notepad.exe fark.txt
    }
}

Read-Host "`nCikmak icin Enter'a basin"
